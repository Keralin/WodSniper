{% extends "base.html" %}

{% block title %}{{ _('New Booking') }} - WodSniper{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <h2>{{ _('New Scheduled Booking') }}</h2>
        <p class="auth-description">
            {{ _('Set up an automatic booking. WodSniper will attempt to book this class every week.') }}
        </p>

        <form method="POST" class="form" id="booking-form">
            {{ form.hidden_tag() }}

            <div class="form-group">
                {{ form.day_of_week.label }}
                <select name="day_of_week" id="day_of_week" class="form-control" required>
                    <option value="">-- {{ _('Select day') }} --</option>
                    <option value="0">{{ _('Monday') }}</option>
                    <option value="1">{{ _('Tuesday') }}</option>
                    <option value="2">{{ _('Wednesday') }}</option>
                    <option value="3">{{ _('Thursday') }}</option>
                    <option value="4">{{ _('Friday') }}</option>
                    <option value="5">{{ _('Saturday') }}</option>
                    <option value="6">{{ _('Sunday') }}</option>
                </select>
                {% for error in form.day_of_week.errors %}
                    <span class="form-error">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group" id="schedule-toggle-group" style="display: none;">
                <label>{{ _('Schedule Type') }}</label>
                <div class="schedule-toggle">
                    <button type="button" class="schedule-btn active" id="btn-special" data-schedule="special">
                        <span class="schedule-btn-icon">ðŸ“…</span>
                        <span class="schedule-btn-label" id="label-special">{{ _('This week') }}</span>
                    </button>
                    <button type="button" class="schedule-btn" id="btn-typical" data-schedule="typical">
                        <span class="schedule-btn-icon">ðŸ“†</span>
                        <span class="schedule-btn-label" id="label-typical">{{ _('Typical schedule') }}</span>
                    </button>
                </div>
                <span class="form-hint schedule-warning" id="schedule-warning"></span>
            </div>

            <div class="form-group">
                <label for="time">{{ _('Time') }}</label>
                <select name="time" id="time" class="form-control" required disabled>
                    <option value="">-- {{ _('Select day first') }} --</option>
                </select>
                <span class="form-hint" id="time-hint">{{ _('Select a day to load available times') }}</span>
                {% for error in form.time.errors %}
                    <span class="form-error">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="class_type">{{ _('Class Type') }}</label>
                <select name="class_type" id="class_type" class="form-control" required disabled>
                    <option value="">-- {{ _('Select time first') }} --</option>
                </select>
                <span class="form-hint" id="class-hint">{{ _('Select a time to load available classes') }}</span>
                {% for error in form.class_type.errors %}
                    <span class="form-error">{{ error }}</span>
                {% endfor %}
            </div>

            <!-- Selection Summary Box -->
            <div class="selection-summary" id="selection-summary" style="display: none;">
                <div class="selection-summary-header">
                    <span class="selection-summary-icon">ðŸ“‹</span>
                    <span class="selection-summary-title">{{ _('Your selection') }}</span>
                    <span class="selection-summary-badge" id="summary-badge" style="display: none;"></span>
                </div>
                <div class="selection-summary-content">
                    <div class="selection-item" id="summary-day">
                        <span class="selection-label">{{ _('Day') }}:</span>
                        <span class="selection-value" id="summary-day-value">-</span>
                    </div>
                    <div class="selection-item" id="summary-time">
                        <span class="selection-label">{{ _('Time') }}:</span>
                        <span class="selection-value" id="summary-time-value">-</span>
                    </div>
                    <div class="selection-item" id="summary-class">
                        <span class="selection-label">{{ _('Class') }}:</span>
                        <span class="selection-value" id="summary-class-value">-</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary btn-block" id="submit-btn" disabled>
                    {{ _('Schedule Booking') }}
                </button>
            </div>
        </form>

        <p class="auth-footer">
            <a href="{{ url_for('booking.dashboard') }}">{{ _('Back to Dashboard') }}</a>
        </p>
    </div>
</div>

<style>
.schedule-toggle {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}
.schedule-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.75rem;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: var(--surface);
    cursor: pointer;
    transition: all 0.2s;
}
.schedule-btn:hover {
    border-color: var(--primary);
}
.schedule-btn.active {
    border-color: var(--primary);
    background: var(--primary-bg);
}
.schedule-btn-icon {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
}
.schedule-btn-label {
    font-size: 0.85rem;
    font-weight: 500;
}
.schedule-warning {
    color: #e9c46a !important;
    font-weight: 500;
}

/* Selection Summary Box */
.selection-summary {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}
.selection-summary.highlight {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(231, 111, 81, 0.2);
}
.selection-summary.special-day {
    border-color: #e9c46a;
    background: linear-gradient(135deg, rgba(233, 196, 106, 0.1) 0%, transparent 100%);
    box-shadow: 0 0 0 3px rgba(233, 196, 106, 0.2);
}
.selection-summary-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
}
.selection-summary-icon {
    font-size: 1.25rem;
}
.selection-summary-title {
    font-weight: 600;
    color: var(--text);
    flex: 1;
}
.selection-summary-badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 600;
    text-transform: uppercase;
}
.selection-summary-badge.typical {
    background: var(--primary);
    color: white;
}
.selection-summary-badge.special {
    background: #e9c46a;
    color: #1a1a2e;
}
.selection-summary-content {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}
.selection-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.selection-label {
    color: var(--text-muted);
    font-size: 0.9rem;
    min-width: 60px;
}
.selection-value {
    font-weight: 600;
    color: var(--text);
    font-size: 0.95rem;
}
.selection-value.empty {
    color: var(--text-muted);
    font-weight: 400;
}
.selection-value.filled {
    color: var(--primary);
}
</style>
<script>
(function() {
    const daySelect = document.getElementById('day_of_week');
    const timeSelect = document.getElementById('time');
    const classSelect = document.getElementById('class_type');
    const submitBtn = document.getElementById('submit-btn');
    const timeHint = document.getElementById('time-hint');
    const classHint = document.getElementById('class-hint');
    const scheduleToggleGroup = document.getElementById('schedule-toggle-group');
    const btnSpecial = document.getElementById('btn-special');
    const btnTypical = document.getElementById('btn-typical');
    const labelSpecial = document.getElementById('label-special');
    const labelTypical = document.getElementById('label-typical');
    const scheduleWarning = document.getElementById('schedule-warning');

    // Selection summary elements
    const selectionSummary = document.getElementById('selection-summary');
    const summaryBadge = document.getElementById('summary-badge');
    const summaryDayValue = document.getElementById('summary-day-value');
    const summaryTimeValue = document.getElementById('summary-time-value');
    const summaryClassValue = document.getElementById('summary-class-value');

    // Translated strings
    const i18n = {
        loading: '{{ _("Loading...") }}',
        selectDayFirst: '-- {{ _("Select day first") }} --',
        selectTimeFirst: '-- {{ _("Select time first") }} --',
        selectTime: '-- {{ _("Select time") }} --',
        selectClass: '-- {{ _("Select class") }} --',
        selectDayHint: '{{ _("Select a day to load available times") }}',
        selectTimeHint: '{{ _("Select a time to load available classes") }}',
        errorLoading: '{{ _("Error loading classes") }}',
        networkError: '{{ _("Network error") }}',
        noClasses: '{{ _("No classes available") }}',
        noClassesDay: '{{ _("No classes found for this day") }}',
        classesFor: '{{ _("Classes for") }}',
        referenceSchedule: '{{ _("Reference schedule") }}',
        basedOnLast: '{{ _("based on last") }}',
        classes: '{{ _("classes") }}',
        classTypesAvailable: '{{ _("class type(s) available at") }}',
        thisWeek: '{{ _("This week") }}',
        typicalSchedule: '{{ _("Typical schedule") }}',
        specialDayWarning: '{{ _("This week has a reduced schedule. Use Typical to see normal classes.") }}',
        timeSlots: '{{ _("time slots") }}',
        typicalScheduleFor: '{{ _("Typical schedule for") }}',
        selectedSchedule: '{{ _("Selected:") }}',
        specialSchedule: '{{ _("Special") }}',
        notSelected: '-'
    };

    // Day names for summary display
    const dayNames = {
        '0': '{{ _("Monday") }}',
        '1': '{{ _("Tuesday") }}',
        '2': '{{ _("Wednesday") }}',
        '3': '{{ _("Thursday") }}',
        '4': '{{ _("Friday") }}',
        '5': '{{ _("Saturday") }}',
        '6': '{{ _("Sunday") }}'
    };

    function updateSelectionSummary() {
        const dayVal = daySelect.value;
        const timeVal = timeSelect.value;
        const classVal = classSelect.value;

        // Show summary if at least day is selected
        if (dayVal) {
            selectionSummary.style.display = 'block';

            // Update day
            summaryDayValue.textContent = dayNames[dayVal] || i18n.notSelected;
            summaryDayValue.classList.toggle('filled', !!dayVal);
            summaryDayValue.classList.toggle('empty', !dayVal);

            // Update time
            summaryTimeValue.textContent = timeVal || i18n.notSelected;
            summaryTimeValue.classList.toggle('filled', !!timeVal);
            summaryTimeValue.classList.toggle('empty', !timeVal);

            // Update class
            const classText = classVal ? classSelect.options[classSelect.selectedIndex].textContent : i18n.notSelected;
            summaryClassValue.textContent = classText;
            summaryClassValue.classList.toggle('filled', !!classVal);
            summaryClassValue.classList.toggle('empty', !classVal);

            // Update styling based on special day and schedule type
            const isSpecialDay = apiData && apiData.is_special_day;
            const isUsingTypical = currentScheduleType === 'typical';

            selectionSummary.classList.toggle('special-day', isSpecialDay && !isUsingTypical);
            selectionSummary.classList.toggle('highlight', classVal && (!isSpecialDay || isUsingTypical));

            // Update badge
            if (isSpecialDay) {
                summaryBadge.style.display = 'inline';
                if (isUsingTypical) {
                    summaryBadge.textContent = i18n.typicalSchedule;
                    summaryBadge.className = 'selection-summary-badge typical';
                } else {
                    summaryBadge.textContent = i18n.specialSchedule;
                    summaryBadge.className = 'selection-summary-badge special';
                }
            } else {
                summaryBadge.style.display = 'none';
            }
        } else {
            selectionSummary.style.display = 'none';
        }
    }

    let classData = {}; // Store classes by time for current selection
    let specialDaySlots = null; // Store special day slots
    let typicalSlots = null; // Store typical schedule slots
    let currentScheduleType = 'special'; // Which schedule is currently shown
    let apiData = null; // Store full API response

    function populateTimeSelect(slots, dateDisplay, isTypical) {
        classData = {};
        timeSelect.innerHTML = '<option value="">' + i18n.selectTime + '</option>';

        if (!slots || slots.length === 0) {
            timeSelect.innerHTML = '<option value="">' + i18n.noClasses + '</option>';
            timeHint.textContent = i18n.noClassesDay;
            timeSelect.disabled = true;
            return;
        }

        slots.forEach(slot => {
            classData[slot.time] = slot.classes;
            const option = document.createElement('option');
            option.value = slot.time;
            option.textContent = slot.time + ' (' + slot.classes.length + ' ' + i18n.classes + ')';
            timeSelect.appendChild(option);
        });

        timeSelect.disabled = false;

        // Show appropriate message based on schedule type
        if (isTypical) {
            timeHint.innerHTML = '<strong style="color: var(--primary);">' + i18n.typicalScheduleFor + ' ' + apiData.day_name + '</strong>';
        } else {
            timeHint.textContent = i18n.classesFor + ' ' + dateDisplay;
        }

        // Reset class select
        classSelect.innerHTML = '<option value="">' + i18n.selectTimeFirst + '</option>';
        classSelect.disabled = true;
        submitBtn.disabled = true;
    }

    function switchSchedule(scheduleType) {
        currentScheduleType = scheduleType;

        // Update button states
        btnSpecial.classList.toggle('active', scheduleType === 'special');
        btnTypical.classList.toggle('active', scheduleType === 'typical');

        // Update selected indicator
        const selectedText = scheduleType === 'typical'
            ? i18n.typicalSchedule + ' (' + typicalSlots.length + ' ' + i18n.timeSlots + ')'
            : i18n.thisWeek + ' (' + specialDaySlots.length + ' ' + i18n.timeSlots + ')';
        scheduleWarning.innerHTML = i18n.selectedSchedule + ' <strong>' + selectedText + '</strong>';

        // Populate with correct data
        if (scheduleType === 'special' && specialDaySlots) {
            populateTimeSelect(specialDaySlots, apiData.date_display, false);
        } else if (scheduleType === 'typical' && typicalSlots) {
            populateTimeSelect(typicalSlots, apiData.typical_date_display, true);
        }

        updateSelectionSummary();
    }

    // Schedule toggle button handlers
    btnSpecial.addEventListener('click', () => switchSchedule('special'));
    btnTypical.addEventListener('click', () => switchSchedule('typical'));

    daySelect.addEventListener('change', function() {
        const day = this.value;

        // Reset everything
        timeSelect.innerHTML = '<option value="">' + i18n.loading + '</option>';
        timeSelect.disabled = true;
        classSelect.innerHTML = '<option value="">' + i18n.selectTimeFirst + '</option>';
        classSelect.disabled = true;
        submitBtn.disabled = true;
        classData = {};
        specialDaySlots = null;
        typicalSlots = null;
        apiData = null;
        scheduleToggleGroup.style.display = 'none';
        currentScheduleType = 'special';
        btnSpecial.classList.add('active');
        btnTypical.classList.remove('active');

        if (!day) {
            timeSelect.innerHTML = '<option value="">' + i18n.selectDayFirst + '</option>';
            timeHint.textContent = i18n.selectDayHint;
            updateSelectionSummary();
            return;
        }

        // Fetch classes for this day
        fetch('/api/classes-by-day/' + day)
            .then(response => response.json())
            .then(data => {
                apiData = data;

                if (data.error) {
                    timeSelect.innerHTML = '<option value="">Error: ' + data.error + '</option>';
                    timeHint.textContent = i18n.errorLoading;
                    return;
                }

                if (!data.slots || data.slots.length === 0) {
                    timeSelect.innerHTML = '<option value="">' + i18n.noClasses + '</option>';
                    timeHint.textContent = i18n.noClassesDay;
                    return;
                }

                // Check if this is a special day with both schedules available
                if (data.is_special_day && data.typical_slots) {
                    specialDaySlots = data.slots;
                    typicalSlots = data.typical_slots;

                    // Update labels with slot counts
                    labelSpecial.textContent = i18n.thisWeek + ' (' + data.slots.length + ' ' + i18n.timeSlots + ')';
                    labelTypical.textContent = i18n.typicalSchedule + ' (' + data.typical_slots.length + ' ' + i18n.timeSlots + ')';

                    // Show warning and toggle
                    scheduleWarning.textContent = i18n.specialDayWarning;
                    scheduleToggleGroup.style.display = 'block';

                    // Default to typical schedule since user probably wants the normal classes
                    switchSchedule('typical');
                } else {
                    // Normal day, just show the slots
                    populateTimeSelect(data.slots, data.date_display, false);

                    // Show reference note if using last week's schedule
                    if (data.is_reference) {
                        timeHint.innerHTML = '<strong style="color: #e9c46a;">âš  ' + i18n.referenceSchedule + '</strong> (' + i18n.basedOnLast + ' ' + data.day_name + ')';
                    }

                    updateSelectionSummary();
                }
            })
            .catch(err => {
                timeSelect.innerHTML = '<option value="">' + i18n.errorLoading + '</option>';
                timeHint.textContent = i18n.networkError;
                console.error('Error:', err);
            });
    });

    timeSelect.addEventListener('change', function() {
        const time = this.value;

        classSelect.innerHTML = '<option value="">' + i18n.selectClass + '</option>';
        classSelect.disabled = true;
        submitBtn.disabled = true;

        if (!time || !classData[time]) {
            classHint.textContent = i18n.selectTimeHint;
            updateSelectionSummary();
            return;
        }

        const classes = classData[time];
        classes.forEach(className => {
            const option = document.createElement('option');
            option.value = className.toLowerCase();
            option.textContent = className;
            classSelect.appendChild(option);
        });

        classSelect.disabled = false;
        classHint.textContent = classes.length + ' ' + i18n.classTypesAvailable + ' ' + time;
        updateSelectionSummary();
    });

    classSelect.addEventListener('change', function() {
        submitBtn.disabled = !this.value;
        updateSelectionSummary();
    });
})();
</script>
{% endblock %}
