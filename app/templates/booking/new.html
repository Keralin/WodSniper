{% extends "base.html" %}

{% block title %}{{ _('New Booking') }} - WodSniper{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <h2>{{ _('New Scheduled Booking') }}</h2>
        <p class="auth-description">
            {{ _('Set up an automatic booking. WodSniper will attempt to book this class every week.') }}
        </p>

        <form method="POST" class="form" id="booking-form">
            {{ form.hidden_tag() }}

            <div class="form-group">
                {{ form.day_of_week.label }}
                <select name="day_of_week" id="day_of_week" class="form-control" required>
                    <option value="">-- {{ _('Select day') }} --</option>
                    <option value="0">{{ _('Monday') }}</option>
                    <option value="1">{{ _('Tuesday') }}</option>
                    <option value="2">{{ _('Wednesday') }}</option>
                    <option value="3">{{ _('Thursday') }}</option>
                    <option value="4">{{ _('Friday') }}</option>
                    <option value="5">{{ _('Saturday') }}</option>
                    <option value="6">{{ _('Sunday') }}</option>
                </select>
                {% for error in form.day_of_week.errors %}
                    <span class="form-error">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="time">{{ _('Time') }}</label>
                <select name="time" id="time" class="form-control" required disabled>
                    <option value="">-- {{ _('Select day first') }} --</option>
                </select>
                <span class="form-hint" id="time-hint">{{ _('Select a day to load available times') }}</span>
                {% for error in form.time.errors %}
                    <span class="form-error">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                <label for="class_type">{{ _('Class Type') }}</label>
                <select name="class_type" id="class_type" class="form-control" required disabled>
                    <option value="">-- {{ _('Select time first') }} --</option>
                </select>
                <span class="form-hint" id="class-hint">{{ _('Select a time to load available classes') }}</span>
                {% for error in form.class_type.errors %}
                    <span class="form-error">{{ error }}</span>
                {% endfor %}
            </div>

            <div class="form-group">
                <button type="submit" class="btn btn-primary btn-block" id="submit-btn" disabled>
                    {{ _('Schedule Booking') }}
                </button>
            </div>
        </form>

        <p class="auth-footer">
            <a href="{{ url_for('booking.dashboard') }}">{{ _('Back to Dashboard') }}</a>
        </p>
    </div>
</div>

<script>
(function() {
    const daySelect = document.getElementById('day_of_week');
    const timeSelect = document.getElementById('time');
    const classSelect = document.getElementById('class_type');
    const submitBtn = document.getElementById('submit-btn');
    const timeHint = document.getElementById('time-hint');
    const classHint = document.getElementById('class-hint');

    // Translated strings
    const i18n = {
        loading: '{{ _("Loading...") }}',
        selectDayFirst: '-- {{ _("Select day first") }} --',
        selectTimeFirst: '-- {{ _("Select time first") }} --',
        selectTime: '-- {{ _("Select time") }} --',
        selectClass: '-- {{ _("Select class") }} --',
        selectDayHint: '{{ _("Select a day to load available times") }}',
        selectTimeHint: '{{ _("Select a time to load available classes") }}',
        errorLoading: '{{ _("Error loading classes") }}',
        networkError: '{{ _("Network error") }}',
        noClasses: '{{ _("No classes available") }}',
        noClassesDay: '{{ _("No classes found for this day") }}',
        classesFor: '{{ _("Classes for") }}',
        referenceSchedule: '{{ _("Reference schedule") }}',
        basedOnLast: '{{ _("based on last") }}',
        classes: '{{ _("classes") }}',
        classTypesAvailable: '{{ _("class type(s) available at") }}'
    };

    let classData = {}; // Store classes by time

    daySelect.addEventListener('change', function() {
        const day = this.value;

        // Reset downstream selects
        timeSelect.innerHTML = '<option value="">' + i18n.loading + '</option>';
        timeSelect.disabled = true;
        classSelect.innerHTML = '<option value="">' + i18n.selectTimeFirst + '</option>';
        classSelect.disabled = true;
        submitBtn.disabled = true;
        classData = {};

        if (!day) {
            timeSelect.innerHTML = '<option value="">' + i18n.selectDayFirst + '</option>';
            timeHint.textContent = i18n.selectDayHint;
            return;
        }

        // Fetch classes for this day
        fetch('/api/classes-by-day/' + day)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    timeSelect.innerHTML = '<option value="">Error: ' + data.error + '</option>';
                    timeHint.textContent = i18n.errorLoading;
                    return;
                }

                if (!data.slots || data.slots.length === 0) {
                    timeSelect.innerHTML = '<option value="">' + i18n.noClasses + '</option>';
                    timeHint.textContent = i18n.noClassesDay;
                    return;
                }

                // Store class data and populate time dropdown
                timeSelect.innerHTML = '<option value="">' + i18n.selectTime + '</option>';
                data.slots.forEach(slot => {
                    classData[slot.time] = slot.classes;
                    const option = document.createElement('option');
                    option.value = slot.time;
                    option.textContent = slot.time + ' (' + slot.classes.length + ' ' + i18n.classes + ')';
                    timeSelect.appendChild(option);
                });

                timeSelect.disabled = false;

                // Show reference note if using last week's schedule
                if (data.is_reference) {
                    timeHint.innerHTML = '<strong style="color: #e9c46a;">âš  ' + i18n.referenceSchedule + '</strong> (' + i18n.basedOnLast + ' ' + data.day_name + ')';
                } else {
                    timeHint.textContent = i18n.classesFor + ' ' + data.date_display;
                }
            })
            .catch(err => {
                timeSelect.innerHTML = '<option value="">' + i18n.errorLoading + '</option>';
                timeHint.textContent = i18n.networkError;
                console.error('Error:', err);
            });
    });

    timeSelect.addEventListener('change', function() {
        const time = this.value;

        classSelect.innerHTML = '<option value="">' + i18n.selectClass + '</option>';
        classSelect.disabled = true;
        submitBtn.disabled = true;

        if (!time || !classData[time]) {
            classHint.textContent = i18n.selectTimeHint;
            return;
        }

        const classes = classData[time];
        classes.forEach(className => {
            const option = document.createElement('option');
            option.value = className.toLowerCase();
            option.textContent = className;
            classSelect.appendChild(option);
        });

        classSelect.disabled = false;
        classHint.textContent = classes.length + ' ' + i18n.classTypesAvailable + ' ' + time;
    });

    classSelect.addEventListener('change', function() {
        submitBtn.disabled = !this.value;
    });
})();
</script>
{% endblock %}
